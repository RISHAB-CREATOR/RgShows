"use strict";import{browser,dnr,localRead,localWrite,localRemove,sessionRead,sessionWrite,adminRead}from"./ext.js";import{broadcastMessage,hostnamesFromMatches,isDescendantHostnameOfIter,toBroaderHostname}from"./utils.js";import{TRUSTED_DIRECTIVE_BASE_RULE_ID,getDynamicRules}from"./ruleset-manager.js";export const MODE_NONE=0;export const MODE_BASIC=1;export const MODE_OPTIMAL=2;export const MODE_COMPLETE=3;const pruneDescendantHostnamesFromSet=(e,t)=>{for(const a of t)!1!==a.endsWith(e)&&a!==e&&"."===a.at(-e.length-1)&&t.delete(a)},pruneHostnameFromSet=(e,t)=>{let a=e;for(;t.delete(a),a=toBroaderHostname(a),"*"!==a;);},eqSets=(e,t)=>{for(const a of t)if(!1===e.has(a))return!1;for(const a of e)if(!1===t.has(a))return!1;return!0},serializeModeDetails=e=>({none:Array.from(e.none),basic:Array.from(e.basic),optimal:Array.from(e.optimal),complete:Array.from(e.complete)}),unserializeModeDetails=e=>({none:new Set(e.none),basic:new Set(e.basic??e.network),optimal:new Set(e.optimal??e.extendedSpecific),complete:new Set(e.complete??e.extendedGeneric)});function lookupFilteringMode(e,t){const{none:a,basic:i,optimal:n,complete:s}=e;return"all-urls"===t?e.none.has("all-urls")?MODE_NONE:e.basic.has("all-urls")?MODE_BASIC:e.optimal.has("all-urls")?MODE_OPTIMAL:e.complete.has("all-urls")?MODE_COMPLETE:MODE_BASIC:a.has(t)||!1===a.has("all-urls")&&isDescendantHostnameOfIter(t,a)?MODE_NONE:i.has(t)||!1===i.has("all-urls")&&isDescendantHostnameOfIter(t,i)?MODE_BASIC:n.has(t)||!1===n.has("all-urls")&&isDescendantHostnameOfIter(t,n)?MODE_OPTIMAL:s.has(t)||!1===s.has("all-urls")&&isDescendantHostnameOfIter(t,s)?MODE_COMPLETE:lookupFilteringMode(e,"all-urls")}function applyFilteringMode(e,t,a){const i=lookupFilteringMode(e,"all-urls");if("all-urls"===t){if(a===i)return a;switch(a){case MODE_NONE:e.none.clear(),e.none.add("all-urls");break;case MODE_BASIC:e.basic.clear(),e.basic.add("all-urls");break;case MODE_OPTIMAL:e.optimal.clear(),e.optimal.add("all-urls");break;case MODE_COMPLETE:e.complete.clear(),e.complete.add("all-urls")}switch(i){case MODE_NONE:e.none.delete("all-urls");break;case MODE_BASIC:e.basic.delete("all-urls");break;case MODE_OPTIMAL:e.optimal.delete("all-urls");break;case MODE_COMPLETE:e.complete.delete("all-urls")}return lookupFilteringMode(e,"all-urls")}const n=lookupFilteringMode(e,t);if(a===n)return a;const{none:s,basic:o,optimal:r,complete:l}=e;switch(n){case MODE_NONE:pruneHostnameFromSet(t,s);break;case MODE_BASIC:pruneHostnameFromSet(t,o);break;case MODE_OPTIMAL:pruneHostnameFromSet(t,r);break;case MODE_COMPLETE:pruneHostnameFromSet(t,l)}if(a!==i)switch(a){case MODE_NONE:!1===isDescendantHostnameOfIter(t,s)&&(e.none.add(t),pruneDescendantHostnamesFromSet(t,s));break;case MODE_BASIC:!1===isDescendantHostnameOfIter(t,o)&&(e.basic.add(t),pruneDescendantHostnamesFromSet(t,o));break;case MODE_OPTIMAL:!1===isDescendantHostnameOfIter(t,r)&&(e.optimal.add(t),pruneDescendantHostnamesFromSet(t,r));break;case MODE_COMPLETE:!1===isDescendantHostnameOfIter(t,l)&&(e.complete.add(t),pruneDescendantHostnamesFromSet(t,l))}return lookupFilteringMode(e,t)}async function readFilteringModeDetails(){if(readFilteringModeDetails.cache)return readFilteringModeDetails.cache;const e=await sessionRead("filteringModeDetails");if(e instanceof Object)return readFilteringModeDetails.cache=unserializeModeDetails(e),readFilteringModeDetails.cache;let[t,a]=await Promise.all([localRead("filteringModeDetails"),localRead("adminNoFiltering")]);if(void 0===t&&(t={basic:["all-urls"]}),t=unserializeModeDetails(t),Array.isArray(a))for(const e of a)applyFilteringMode(t,e,0);return filteringModesToDNR(t),sessionWrite("filteringModeDetails",serializeModeDetails(t)),readFilteringModeDetails.cache=t,adminRead("noFiltering").then((e=>{e?localWrite("adminNoFiltering",e):localRemove("adminNoFiltering")})),t}async function writeFilteringModeDetails(e){await filteringModesToDNR(e);const t=serializeModeDetails(e);localWrite("filteringModeDetails",t),sessionWrite("filteringModeDetails",t),readFilteringModeDetails.cache=unserializeModeDetails(t),Promise.all([getDefaultFilteringMode(),getTrustedSites()]).then((e=>{broadcastMessage({defaultFilteringMode:e[0],trustedSites:Array.from(e[1])})}))}async function filteringModesToDNR(e){const t=await getDynamicRules(),a=t.get(TRUSTED_DIRECTIVE_BASE_RULE_ID),i=new Set(a&&a.condition.requestDomains);if(eqSets(i,e.none))return;const n=[];void 0!==a&&(n.push(TRUSTED_DIRECTIVE_BASE_RULE_ID),t.delete(TRUSTED_DIRECTIVE_BASE_RULE_ID));const s=[];if(0!==e.none.size){const a={id:TRUSTED_DIRECTIVE_BASE_RULE_ID,action:{type:"allowAllRequests"},condition:{resourceTypes:["main_frame"]},priority:100};1===e.none.size&&!1!==e.none.has("all-urls")||(a.condition.requestDomains=Array.from(e.none)),s.push(a),t.set(TRUSTED_DIRECTIVE_BASE_RULE_ID,a)}const o={};s.length&&(o.addRules=s),n.length&&(o.removeRuleIds=n),await dnr.updateDynamicRules(o)}export async function getFilteringModeDetails(){const e=await readFilteringModeDetails();return{none:new Set(e.none),basic:new Set(e.basic),optimal:new Set(e.optimal),complete:new Set(e.complete)}}export async function getFilteringMode(e){return lookupFilteringMode(await getFilteringModeDetails(),e)}export async function setFilteringMode(e,t){const a=await getFilteringModeDetails(),i=applyFilteringMode(a,e,t);return await writeFilteringModeDetails(a),i}export function getDefaultFilteringMode(){return getFilteringMode("all-urls")}export function setDefaultFilteringMode(e){return setFilteringMode("all-urls",e)}export async function getTrustedSites(){return(await getFilteringModeDetails()).none}export async function setTrustedSites(e){const t=await getFilteringModeDetails(),{none:a}=t,i=new Set(e);let n=!1;for(const e of a)i.has(e)?i.delete(e):(a.delete(e),n=!0);for(const e of i){applyFilteringMode(t,e,MODE_NONE)===MODE_NONE&&(n=!0)}if(!1!==n)return writeFilteringModeDetails(t)}export async function syncWithBrowserPermissions(){const[e,t]=await Promise.all([browser.permissions.getAll(),getDefaultFilteringMode()]),a=new Set(hostnamesFromMatches(e.origins||[]));let i=!1;t>MODE_BASIC&&!1===a.has("all-urls")&&(await setDefaultFilteringMode(MODE_BASIC),i=!0);if(await getDefaultFilteringMode()>MODE_BASIC)return!1;const n=await getFilteringModeDetails(),{optimal:s,complete:o}=n;for(const e of s)a.has(e)||(s.delete(e),i=!0);for(const e of o)a.has(e)||(o.delete(e),i=!0);return await writeFilteringModeDetails(n),i}