"use strict";import{browser,sendMessage,localRead,localWrite}from"./ext.js";import{i18n$,i18n}from"./i18n.js";import{dom,qs$,qsa$}from"./dom.js";import punycode from"./punycode.js";const rulesetMap=new Map;let cachedRulesetData={},hideUnusedSet=new Set(["regions"]);function renderNumber(e){return e.toLocaleString()}function hashFromIterable(e){return Array.from(e).sort().join("\n")}function rulesetStats(e){const t=cachedRulesetData.defaultFilteringMode>1,s=rulesetMap.get(e);if(void 0===s)return;const{rules:a,filters:o}=s;let n=a.plain+a.regex;t&&(n+=a.removeparam+a.redirect+a.modifyHeaders);return{ruleCount:n,filterCount:o.accepted}}function renderFilterLists(){const{enabledRulesets:e,rulesetDetails:t}=cachedRulesetData,s=qs$("#templates .groupEntry"),a=qs$("#templates .listEntry"),o=i18n$("perRulesetStats"),n=new Map([["user",""]]),r=function(t,s,n){s||(s=dom.clone(a));const r=e.includes(t.id);dom.cl.toggle(s,"checked",r),dom.cl.toggle(s,"unused",n&&!r),qs$(s,'input[type="checkbox"]').checked=r,dom.attr(s,"data-listkey")!==t.id&&(dom.attr(s,"data-listkey",t.id),qs$(s,".listname").append(i18n.patchUnicodeFlags(t.name)),dom.cl.remove(s,"toRemove"),t.homeURL?(dom.cl.add(s,"support"),dom.attr(qs$(s,"a.support"),"href",t.homeURL)):dom.cl.remove(s,"support"),t.instructionURL?(dom.cl.add(s,"mustread"),dom.attr(qs$(s,"a.mustread"),"href",t.instructionURL)):dom.cl.remove(s,"mustread"),dom.cl.toggle(s,"isDefault","default"===t.id));const d=rulesetStats(t.id);return s.title=o.replace("{{ruleCount}}",renderNumber(d.ruleCount)).replace("{{filterCount}}",renderNumber(d.filterCount)),dom.attr(qs$(s,".input.checkbox"),"disabled",0===d.ruleCount?"":null),dom.cl.remove(s,"discard"),s},d=function(t,a){let o=qs$(`#lists > .groupEntry[data-groupkey="${t}"]`);if(null===o){o=dom.clone(s);let e=n.get(t);void 0===e&&(e=i18n$("3pGroup"+t.charAt(0).toUpperCase()+t.slice(1)),n.set(t,e)),""!==e&&dom.text(qs$(o,".geName"),e)}null===qs$(o,".geName:empty")&&dom.text(qs$(o,".geCount"),function(t){if(!1===Array.isArray(t))return"";let s=0,a=0;for(const o of t)e.includes(o.id)&&(s+=1),a+=1;return 0!==a?`(${s.toLocaleString()}/${a.toLocaleString()})`:""}(a));const d=mustHideUnusedLists(t);dom.cl.toggle(o,"hideUnused",d);const l=qs$(o,".listEntries");if(!a)return o;a.sort((function(e,t){return(e.name||"").localeCompare(t.name||"")}));for(let e=0;e<a.length;e++){const t=r(a[e],l.children[e],d);null===t.parentElement&&l.appendChild(t)}return o},l=qs$("#lists"),i=new Map([["default",t.filter((e=>"default"===e.id))],["annoyances",t.filter((e=>"annoyances"===e.group))],["misc",t.filter((e=>"default"!==e.id&&void 0===e.group&&"string"!=typeof e.lang))],["regions",t.filter((e=>"string"==typeof e.lang))]]);dom.cl.toggle(dom.body,"hideUnused",mustHideUnusedLists("*"));for(const[e,t]of i){const s=d(e,t);dom.attr(s,"data-groupkey",e),null===s.parentElement&&l.appendChild(s)}}function renderWidgets(){cachedRulesetData.firstRun&&dom.cl.add(dom.body,"firstRun"),renderDefaultMode(),renderTrustedSites(),qs$('#autoReload input[type="checkbox"').checked=cachedRulesetData.autoReload;let e=0,t=0,s=0;for(const a of qsa$("#lists .listEntry[data-listkey]")){if(null===qs$(a,'input[type="checkbox"]:checked'))continue;e+=1;const o=rulesetStats(a.dataset.listkey);void 0!==o&&(s+=o.ruleCount,t+=o.filterCount)}dom.text("#listsOfBlockedHostsPrompt",i18n$("perRulesetStats").replace("{{ruleCount}}",s.toLocaleString()).replace("{{filterCount}}",t.toLocaleString())),dom.cl.toggle(dom.body,"noMoreRuleset",e===cachedRulesetData.maxNumberOfEnabledRulesets)}function renderDefaultMode(){const e=cachedRulesetData.defaultFilteringMode;0!==e?qs$(`.filteringModeCard input[type="radio"][value="${e}"]`).checked=!0:dom.prop('.filteringModeCard input[type="radio"]',"checked",!1)}async function onFilteringModeChange(e){const t=e.target,s=parseInt(t.value,10);switch(s){case 1:await browser.permissions.remove({origins:["<all_urls>"]}),cachedRulesetData.defaultFilteringMode=1;break;case 2:case 3:if(await browser.permissions.request({origins:["<all_urls>"]})){const e=await sendMessage({what:"setDefaultFilteringMode",level:s});cachedRulesetData.defaultFilteringMode=e}break}renderFilterLists(),renderWidgets()}function renderTrustedSites(){const e=qs$("#trustedSites"),t=cachedRulesetData.trustedSites;e.value=t.map((e=>punycode.toUnicode(e))).join("\n"),""!==e.value&&(e.value+="\n")}function changeTrustedSites(){const e=getStagedTrustedSites(),t=hashFromIterable(cachedRulesetData.trustedSites);hashFromIterable(e)!==t&&sendMessage({what:"setTrustedSites",hostnames:e})}function getStagedTrustedSites(){return qs$("#trustedSites").value.split(/\s/).map((e=>{try{return punycode.toASCII(new URL(`https://${e}/`).hostname)}catch(e){}return""})).filter((e=>""!==e))}async function applyEnabledRulesets(){const e=[];for(const t of qsa$("#lists .listEntry[data-listkey]")){const s=null!==qs$(t,'input[type="checkbox"]:checked');dom.cl.toggle(t,"checked",s),!1!==s&&e.push(t.dataset.listkey)}await sendMessage({what:"applyRulesets",enabledRulesets:e}),renderWidgets()}function mustHideUnusedLists(e){const t=hideUnusedSet.has("*");return"*"===e?t:hideUnusedSet.has(e)!==t}function toggleHideUnusedLists(e){const t=hideUnusedSet.has("*");let s,a;if("*"===e)a=!1===t,s="",hideUnusedSet.clear(),a&&hideUnusedSet.add(e),dom.cl.toggle(dom.body,"hideUnused",a),dom.cl.toggle(".groupEntry[data-groupkey]","hideUnused",a);else{const o=hideUnusedSet.has(e);o?hideUnusedSet.delete(e):hideUnusedSet.add(e),a=o===t,s=`.groupEntry[data-groupkey="${e}"]`,dom.cl.toggle(s,"hideUnused",a)}for(const e of qsa$(`#lists ${s} .listEntry[data-listkey] input[type="checkbox"]:not(:checked)`))dom.cl.toggle(e.closest(".listEntry[data-listkey]"),"unused",a);localWrite("hideUnusedFilterLists",Array.from(hideUnusedSet))}dom.on("#defaultFilteringMode","change",'.filteringModeCard input[type="radio"]',(e=>{onFilteringModeChange(e)})),dom.on('#autoReload input[type="checkbox"',"change",(e=>{sendMessage({what:"setAutoReload",state:e.target.checked})})),dom.on("#trustedSites","blur",changeTrustedSites),self.addEventListener("beforeunload",changeTrustedSites),dom.on("#lists","change",'.listEntry input[type="checkbox"]',(()=>{applyEnabledRulesets()})),dom.on("#lists","click",".groupEntry[data-groupkey] > .geDetails",(e=>{toggleHideUnusedLists(dom.attr(e.target.closest("[data-groupkey]"),"data-groupkey"))})),localRead("hideUnusedFilterLists").then((e=>{!1!==Array.isArray(e)&&(hideUnusedSet=new Set(e))}));const bc=new self.BroadcastChannel("uBOL");bc.onmessage=e=>{const t=e.data;if(t instanceof Object==!1)return;const s=cachedRulesetData;let a=!1;if(void 0!==t.trustedSites&&hashFromIterable(t.trustedSites)!==hashFromIterable(s.trustedSites)){const e=new Set(s.trustedSites),o=new Set(getStagedTrustedSites());for(const t of o)!1!==e.has(t)&&o.delete(t);const n=Array.from(new Set([...t.trustedSites,...o]));s.trustedSites=n,a=!0}void 0!==t.defaultFilteringMode&&t.defaultFilteringMode!==s.defaultFilteringMode&&(s.defaultFilteringMode=t.defaultFilteringMode,a=!0),void 0!==t.autoReload&&t.autoReload!==s.autoReload&&(s.autoReload=t.autoReload,a=!0),void 0!==t.enabledRulesets&&hashFromIterable(t.enabledRulesets)!==hashFromIterable(s.enabledRulesets)&&(s.enabledRulesets=t.enabledRulesets,a=!0),!1!==a&&(renderFilterLists(),renderWidgets())},sendMessage({what:"getOptionsPageData"}).then((e=>{if(e){cachedRulesetData=e,rulesetMap.clear(),cachedRulesetData.rulesetDetails.forEach((e=>rulesetMap.set(e.id,e)));try{renderFilterLists(),renderWidgets()}catch(e){}}})).catch((e=>{console.trace(e)}));