"use strict";import{browser,dnr,runtime,localRead,localWrite,sessionRead,sessionWrite,adminRead}from"./ext.js";import{getRulesetDetails,defaultRulesetsFromLanguage,enableRulesets,getEnabledRulesetsDetails,updateDynamicRules}from"./ruleset-manager.js";import{registerInjectables}from"./scripting-manager.js";import{getFilteringMode,setFilteringMode,getDefaultFilteringMode,setDefaultFilteringMode,getTrustedSites,setTrustedSites,syncWithBrowserPermissions}from"./mode-manager.js";import{broadcastMessage,ubolLog}from"./utils.js";const rulesetConfig={version:"",enabledRulesets:["default"],autoReload:!0},UBOL_ORIGIN=runtime.getURL("").replace(/\/$/,"");let firstRun=!1,wakeupRun=!1;function getCurrentVersion(){return runtime.getManifest().version}async function loadRulesetConfig(){let e=await sessionRead("rulesetConfig");return e?(rulesetConfig.version=e.version,rulesetConfig.enabledRulesets=e.enabledRulesets,rulesetConfig.autoReload=!!e.autoReload,void(wakeupRun=!0)):(e=await localRead("rulesetConfig"),e?(rulesetConfig.version=e.version,rulesetConfig.enabledRulesets=e.enabledRulesets,rulesetConfig.autoReload=!!e.autoReload,void sessionWrite("rulesetConfig",rulesetConfig)):(rulesetConfig.enabledRulesets=await defaultRulesetsFromLanguage(),sessionWrite("rulesetConfig",rulesetConfig),localWrite("rulesetConfig",rulesetConfig),void(firstRun=!0)))}async function saveRulesetConfig(){return sessionWrite("rulesetConfig",rulesetConfig),localWrite("rulesetConfig",rulesetConfig)}async function hasGreatPowers(e){return!1!==/^https?:\/\//.test(e)&&browser.permissions.contains({origins:[`${e}/*`]})}function hasOmnipotence(){return browser.permissions.contains({origins:["<all_urls>"]})}async function onPermissionsRemoved(){const e=await getDefaultFilteringMode();if(!1===await syncWithBrowserPermissions())return!1;const t=await getDefaultFilteringMode();return e>1&&t<=1&&updateDynamicRules(),registerInjectables(),!0}function onMessage(e,t,s){if("insertCSS"===e.what){const s=t?.tab?.id??!1,n=t?.frameId??!1;if(!1===s||!1===n)return;return browser.scripting.insertCSS({css:e.css,origin:"USER",target:{tabId:s,frameIds:[n]}}).catch((e=>{console.log(e)})),!1}if(void 0===t.origin||t.origin===UBOL_ORIGIN)switch(e.what){case"applyRulesets":return enableRulesets(e.enabledRulesets).then((()=>(rulesetConfig.enabledRulesets=e.enabledRulesets,saveRulesetConfig()))).then((()=>{registerInjectables(),s(),broadcastMessage({enabledRulesets:rulesetConfig.enabledRulesets})})),!0;case"getOptionsPageData":return Promise.all([getDefaultFilteringMode(),getTrustedSites(),getRulesetDetails(),dnr.getEnabledRulesets()]).then((e=>{const[t,n,r,i]=e;s({defaultFilteringMode:t,trustedSites:Array.from(n),enabledRulesets:i,maxNumberOfEnabledRulesets:dnr.MAX_NUMBER_OF_ENABLED_STATIC_RULESETS,rulesetDetails:Array.from(r.values()),autoReload:rulesetConfig.autoReload,firstRun}),firstRun=!1})),!0;case"setAutoReload":return rulesetConfig.autoReload=!!e.state,saveRulesetConfig().then((()=>{s(),broadcastMessage({autoReload:rulesetConfig.autoReload})})),!0;case"popupPanelData":return Promise.all([getFilteringMode(e.hostname),hasOmnipotence(),hasGreatPowers(e.origin),getEnabledRulesetsDetails()]).then((e=>{s({level:e[0],autoReload:rulesetConfig.autoReload,hasOmnipotence:e[1],hasGreatPowers:e[2],rulesetDetails:e[3]})})),!0;case"getFilteringMode":return getFilteringMode(e.hostname).then((e=>{s(e)})),!0;case"setFilteringMode":return getFilteringMode(e.hostname).then((t=>e.level===t?t:setFilteringMode(e.hostname,e.level))).then((e=>{registerInjectables(),s(e)})),!0;case"setDefaultFilteringMode":return getDefaultFilteringMode().then((t=>setDefaultFilteringMode(e.level).then((e=>({beforeLevel:t,afterLevel:e}))))).then((({beforeLevel:e,afterLevel:t})=>{1!==e&&1!==t||updateDynamicRules(),t!==e&&registerInjectables(),s(t)})),!0;case"setTrustedSites":return setTrustedSites(e.hostnames).then((()=>(registerInjectables(),Promise.all([getDefaultFilteringMode(),getTrustedSites()])))).then((e=>{s({defaultFilteringMode:e[0],trustedSites:Array.from(e[1])})})),!0}}async function start(){if(await loadRulesetConfig(),!1===wakeupRun&&await enableRulesets(rulesetConfig.enabledRulesets),!1===wakeupRun){const e=getCurrentVersion();e!==rulesetConfig.version&&(ubolLog(`Version change: ${rulesetConfig.version} => ${e}`),updateDynamicRules().then((()=>{rulesetConfig.version=e,saveRulesetConfig()})))}const e=await onPermissionsRemoved();if(!1===wakeupRun||e){registerInjectables();const e=await dnr.getEnabledRulesets();ubolLog(`Enabled rulesets: ${e}`),dnr.getAvailableStaticRuleCount().then((e=>{ubolLog(`Available static rule count: ${e}`)}))}if(!1===wakeupRun&&dnr.setExtensionActionOptions,runtime.onMessage.addListener(onMessage),browser.permissions.onRemoved.addListener((()=>{onPermissionsRemoved()})),firstRun){await adminRead("disableFirstRunPage")}}try{start()}catch(e){console.trace(e)}